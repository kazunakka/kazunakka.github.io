<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Still Time ç‘æƒ³ãƒ­ã‚°ç·¨é›†ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #4d8a8a; 
            border-bottom: 2px solid #66b2b2;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        h2 {
            color: #66b2b2;
            margin-top: 30px;
            font-size: 1.4em;
        }
        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 10px;
            resize: vertical;
            font-family: monospace;
        }
        button {
            padding: 10px 18px;
            background-color: #66b2b2;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 0; 
            font-size: 1em;
            font-weight: bold;
        }
        button:hover {
            background-color: #4d8a8a;
        }

        /* â˜…ä¿®æ­£: ãƒ­ã‚°è¡¨ç¤º/æ›´æ–°ãƒœã‚¿ãƒ³ã®ä¸‹ã«ãƒãƒ¼ã‚¸ãƒ³ã‚’è¿½åŠ  */
        #logDisplayButton {
            margin-bottom: 20px; 
        }

        /* ãƒ­ã‚°ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒœã‚¿ãƒ³ã®èª¿æ•´ */
        #exportButton {
            margin-bottom: 10px; 
            display: block; 
            width: 100%; 
        }
        #addRowButton {
            display: block; 
            width: 100%; 
        }
        @media (min-width: 600px) {
            #exportButton {
                margin-right: 15px; 
                margin-bottom: 0;
                display: inline-block;
                width: auto;
            }
            #addRowButton {
                display: inline-block;
                width: auto;
            }
        }
        /* --- ä¿®æ­£ç®‡æ‰€ã“ã“ã¾ã§ --- */

        table {
            width: 100%;
            min-width: 750px; 
            border-collapse: separate; 
            border-spacing: 0;
            overflow: hidden;
            border-radius: 8px;
        }
        th, td {
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            padding: 12px 8px;
            text-align: left;
            vertical-align: middle;
        }
        
        .memo-input {
            width: 100%;
            border: 1px solid #eee;
            padding: 5px;
            box-sizing: border-box;
            border-radius: 4px;
            white-space: normal; 
        }

        th:last-child, td:last-child {
            border-right: none;
        }
        th {
            background-color: #eef4f4;
            font-weight: bold;
            color: #333;
            border-top: 1px solid #ddd;
            white-space: nowrap; 
        }
        #logTable thead th {
            width: auto; 
        }
        #logTable thead tr th:nth-child(4) {
            width: 45%; 
        }

        tr:last-child td {
            border-bottom: none;
        }
        .mood-select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .duration-input {
            width: 60px;
            text-align: right;
            border: 1px solid #eee;
            padding: 5px;
            border-radius: 4px;
        }
        .date-display {
            font-size: 0.8em;
            color: #888;
        }
        .hidden {
            display: none;
        }
        .error {
            color: #d9534f;
            background-color: #f2dede;
            border: 1px solid #ebccd1;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        #logTableContainer {
            margin-top: 20px; 
            overflow-x: auto; 
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Still Time ç‘æƒ³ãƒ­ã‚°ç·¨é›†ãƒ„ãƒ¼ãƒ«</h1>
    <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ã‚¢ãƒ—ãƒªã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸJSONãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§èª­ã¿è¾¼ã¿ã€ç·¨é›†ã—ã€å†åº¦ã‚¢ãƒ—ãƒªã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹å½¢å¼ã§å‡ºåŠ›ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚</p>

    <h2>1. JSONãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
    <textarea id="jsonInput" placeholder='ã‚¢ãƒ—ãƒªã®ã€Œãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€æ©Ÿèƒ½ã§ã‚³ãƒ”ãƒ¼ã—ãŸJSONãƒ‡ãƒ¼ã‚¿ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚'></textarea>
    <button id="logDisplayButton" onclick="displayLogs()">ãƒ­ã‚°ã‚’è¡¨ç¤º / æ›´æ–°</button> 
    <div id="errorDisplay" class="error hidden"></div>

    <h2 id="editHeader" class="hidden">2. ãƒ­ã‚°ã®ç·¨é›†ã¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
    
    <div id="exportSection" style="margin-bottom: 20px;">
        <button id="exportButton" class="hidden" onclick="exportLogs()">ç·¨é›†ã—ãŸJSONã‚’ç”Ÿæˆ & ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
        <button id="addRowButton" class="hidden" onclick="addRow()">+ æ–°ã—ã„ãƒ­ã‚°ã‚’è¿½åŠ </button>
        <p id="exportMessage" class="hidden" style="margin-top: 10px; color: #555;">ã‚³ãƒ”ãƒ¼ã•ã‚ŒãŸJSONæ–‡å­—åˆ—ã‚’ã‚¢ãƒ—ãƒªã®ã€Œãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå¾©å…ƒï¼‰ã€æ©Ÿèƒ½ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
        <textarea id="jsonOutput" class="hidden" readonly></textarea>
    </div>

    <div id="logTableContainer">
        <table id="logTable" class="hidden">
            <thead>
                <tr>
                    <th>æ—¥æ™‚ (ä½œæˆ/å¾©å…ƒæ—¥æ™‚)</th>
                    <th>æ™‚é–“ (åˆ†)</th>
                    <th>æ°—åˆ†</th>
                    <th>ãƒ¡ãƒ¢</th> 
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

<script>
    // 1: Bad, 5: Great
    const MOOD_MAPPING = {
        1: 'ğŸ˜« (1: æœ€æ‚ª)',
        2: 'ğŸ˜ (2: è‰¯ããªã„)',
        3: 'ğŸ˜ (3: æ™®é€š)',
        4: 'ğŸ™‚ (4: è‰¯ã„)',
        5: 'ğŸ˜€ (5: æœ€é«˜)'
    };

    function toggleElements(visible) {
        document.getElementById('editHeader').classList.toggle('hidden', !visible);
        document.getElementById('logTable').classList.toggle('hidden', !visible);
        document.getElementById('addRowButton').classList.toggle('hidden', !visible); 
        document.getElementById('exportButton').classList.toggle('hidden', !visible); 
        document.getElementById('jsonOutput').classList.add('hidden');
        document.getElementById('exportMessage').classList.add('hidden');
    }

    function getMoodEmoji(value) {
        return MOOD_MAPPING[value] || 'ğŸ˜ (3: æ™®é€š)';
    }

    function displayLogs() {
        const input = document.getElementById('jsonInput').value.trim();
        const tbody = document.getElementById('logTable').querySelector('tbody');
        const errorDisplay = document.getElementById('errorDisplay');

        tbody.innerHTML = '';
        errorDisplay.classList.add('hidden');
        toggleElements(false);

        if (!input) {
            errorDisplay.textContent = 'JSONãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚';
            errorDisplay.classList.remove('hidden');
            return;
        }

        try {
            const logs = JSON.parse(input);
            if (!Array.isArray(logs)) {
                throw new Error('JSONãƒ‡ãƒ¼ã‚¿ã¯é…åˆ—å½¢å¼ï¼ˆ[...]ï¼‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
            }

            logs.forEach(log => {
                if (log.date && typeof log.durationMinutes === 'number') {
                    addLogToTable(log);
                } else {
                    console.warn("Skipping invalid log entry:", log);
                }
            });

            if (tbody.rows.length > 0) {
                toggleElements(true);
            } else {
                 errorDisplay.textContent = 'JSONãƒ‡ãƒ¼ã‚¿å†…ã«æœ‰åŠ¹ãªç‘æƒ³ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                errorDisplay.classList.remove('hidden');
            }
        } catch (e) {
            errorDisplay.textContent = 'JSONãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚¨ãƒ©ãƒ¼: ' + e.message;
            errorDisplay.classList.remove('hidden');
        }
    }

    function createMoodSelect(initialValue) {
        const select = document.createElement('select');
        select.className = 'mood-select';

        for (let val = 1; val <= 5; val++) {
            const option = document.createElement('option');
            option.value = val;
            option.textContent = getMoodEmoji(val);
            if (val === (initialValue || 3)) {
                option.selected = true;
            }
            select.appendChild(option);
        }
        return select;
    }

    function addLogToTable(logData) {
        const tbody = document.getElementById('logTable').querySelector('tbody');
        const row = tbody.insertRow();
        row.dataset.originalDate = logData.date;

        const dateCell = row.insertCell();
        const dateObj = new Date(logData.date);
        dateCell.innerHTML = `
            ${dateObj.getFullYear()}/${dateObj.getMonth() + 1}/${dateObj.getDate()}
            <br>
            <span class="date-display">${String(dateObj.getHours()).padStart(2, '0')}:${String(dateObj.getMinutes()).padStart(2, '0')}</span>
        `;

        const durationCell = row.insertCell();
        const durationInput = document.createElement('input');
        durationInput.type = 'number';
        durationInput.min = '1';
        durationInput.value = logData.durationMinutes || 5;
        durationInput.className = 'duration-input';
        durationCell.appendChild(durationInput);

        const moodCell = row.insertCell();
        const moodSelect = createMoodSelect(logData.mood);
        moodCell.appendChild(moodSelect);

        const memoCell = row.insertCell();
        const memoInput = document.createElement('input');
        memoInput.type = 'text';
        memoInput.value = logData.memo || '';
         memoInput.className = 'memo-input';
        memoCell.appendChild(memoInput);

        const deleteCell = row.insertCell();
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'å‰Šé™¤';
        deleteButton.style.backgroundColor = '#d9534f'; 
        deleteButton.style.marginRight = '0';
        deleteButton.onclick = function() {
            tbody.removeChild(row);
            if (tbody.rows.length === 0) {
                 toggleElements(false);
            }
        };
        deleteCell.appendChild(deleteButton);
    }

    function addRow() {
        const newLog = {
            date: new Date().toISOString(),
            durationMinutes: 10,
            mood: 3,
            memo: 'æ–°è¦è¿½åŠ ã®ãƒ­ã‚°',
        };
        addLogToTable(newLog);
    }

    function exportLogs() {
        const tbody = document.getElementById('logTable').querySelector('tbody');
        const rows = tbody.querySelectorAll('tr');
        const exportedLogs = [];

        rows.forEach(row => {
            const durationInput = row.cells[1].querySelector('input').value;
            const moodSelect = row.cells[2].querySelector('select').value;
            const memoInput = row.cells[3].querySelector('input').value;

            const log = {
                date: row.dataset.originalDate,
                durationMinutes: parseInt(durationInput) || 1,
                mood: parseInt(moodSelect) || 3,
                memo: memoInput.trim(),
            };
            exportedLogs.push(log);
        });

        exportedLogs.sort((a, b) => new Date(a.date) - new Date(b.date));

        const jsonString = JSON.stringify(exportedLogs);

        document.getElementById('jsonOutput').value = jsonString;
        document.getElementById('jsonOutput').classList.remove('hidden');
        document.getElementById('exportMessage').classList.remove('hidden');

        navigator.clipboard.writeText(jsonString).then(() => {
            alert('ç·¨é›†ã—ãŸJSONãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼\nã‚¢ãƒ—ãƒªã«æˆ»ã£ã¦ã€Œãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€æ©Ÿèƒ½ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
            document.getElementById('jsonOutput').select();
            alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nå‡ºåŠ›ã‚¨ãƒªã‚¢ã®JSONã‚’ã™ã¹ã¦æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        toggleElements(false);
    });
</script>
</body>
</html>